#! /usr/bin/env python
__version__ = "0.1"

import argparse
import PyCosmic


parser = argparse.ArgumentParser(description="""
Programm to detects cosmics in single exposure CCD frames. Important: The raw
frame is expected to be BIAS subtracted and in electron units! A bad pixel mask of cosmics and a cleaned image will be provided by the routine as an output.""", formatter_class=argparse.ArgumentDefaultsHelpFormatter )

parser.add_argument("raw", type=str, help="""File name of the CCD raw frame FITS file from which to detect and reject cosmic ray hits. This frame is expected to be BIAS subtracted and in units of electrons and not in ADUs!
""")
parser.add_argument("clean", type=str, help="""File name of the cosmics cleaned frame to be stored as a FITS file.
""")
parser.add_argument("mask", type=str, help="""File name of the cosmics mask  frame to be stored as a FITS file.
""")
parser.add_argument("rdnoise", type=str, help="""Header keyword in the raw frame with the information of the read-out noise in electrons.
""")

parser.add_argument("--siglim", type=float, default=5.0, help="""Threshold value for the significance level of cosmics in units of the expected noise for the pixels.
Default
is 5.0.""")
parser.add_argument("--rlim", type=float, default=1.2, help="""Threshold value for the contrast value of cosmics against the smooth signal of the object. The optimal value depends on the FWHM of the instrument PSF and the FWHM of the 
Gaussian smoothing kernel, i.e. --fwhm.
Default
is 1.2.""")
parser.add_argument("--iter", type=int, default=5, help="""Number of iteration to be performed by the algorithms. Usually 5-6 iterations are needed to converge to a stable solution.
Default
is 5.""")
parser.add_argument("--fwhm", type=float,  default=2.0, help="""FWHM in pixels of the Gaussian convolution kernel used for the detection of cosmics. Should always been smaller than the FWHM of the instrumental PSF.
Default
is 2.0,2.0.""")
parser.add_argument("--replacebox", type=int, nargs=2,  default=[5,5], help="""Size of the subimage (x and y-axis) around a detected cosmic ray pixel used to estimate a median value  from the unaffacted pixel in order to produce a cleaned frame. 
Default
is 5,5.""")
parser.add_argument("--radius", type=int, default=0, help="""Number of neighboring pixel used to increase the boundaries of the detected cosmics. Should only be used if considered to be absolutely necessary.
Default
is 0.""")
parser.add_argument("--parallel", type=bool, default=True, help="""Flag to use 2 CPUs cores in parallel for the computations to speed up the process.
Default
is True.""")
parser.add_argument("--verbose", type=bool, default=True, help="""Flag to print some progress information on the screen.
Default
is 1.""")

args = parser.parse_args()

PyCosmic.mod_LACosmic(args.raw, args.mask, args.clean, args.rdnoise, sigma_det=args.siglim,  rlim=args.rlim, iter=args.iter, fwhm_gauss=args.fwhm, replace_box=args.replacebox,    increase_radius=args.radius, parallel=args.parallel, verbose=args.verbose)

